<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D365 Integration - PMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">PMS</div>
            <nav class="nav"></nav>
            <div class="user-menu">
                <div class="notification-badge">
                    <span class="badge" style="display: none;">0</span>
                    <span>ðŸ””</span>
                </div>
                <span id="username"></span>
                <button class="btn btn-sm btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h1>Microsoft Dynamics 365 Integration</h1>
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div class="card-header" style="margin: 0;">Integration Configurations</div>
                <button class="btn btn-primary" onclick="showModal('addD365ConfigModal')">Add Configuration</button>
            </div>
            
            <table class="table">
                <thead>
                    <tr>
                        <th>Config Name</th>
                        <th>Endpoint URL</th>
                        <th>Sync Frequency</th>
                        <th>Last Sync</th>
                        <th>Next Sync</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="d365ConfigsTable">
                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-header">Sync History</div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Config</th>
                        <th>Entity Type</th>
                        <th>Direction</th>
                        <th>Processed</th>
                        <th>Success</th>
                        <th>Failed</th>
                        <th>Status</th>
                        <th>Started At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="syncLogsTable">
                    <tr><td colspan="9" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="addD365ConfigModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">Add D365 Configuration</div>
            <form id="d365ConfigForm">
                <div class="form-group">
                    <label class="form-label" for="configName">Configuration Name*</label>
                    <input type="text" id="configName" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="endpointUrl">D365 Endpoint URL*</label>
                    <input type="url" id="endpointUrl" class="form-input" required placeholder="https://...">
                </div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="authType">Authentication Type*</label>
                        <select id="authType" class="form-select" required onchange="toggleAuthFields()">
                            <option value="oauth">OAuth</option>
                            <option value="api_key">API Key</option>
                            <option value="basic">Basic Auth</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="syncFrequency">Sync Frequency (Minutes)*</label>
                        <input type="number" id="syncFrequency" class="form-input" required value="60">
                    </div>
                </div>
                
                <div id="authFieldsContainer"></div>
                
                <div class="form-group">
                    <label class="form-label" for="syncEntities">Entities to Sync*</label>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <label><input type="checkbox" class="sync-entity" value="orders"> Orders</label>
                        <label><input type="checkbox" class="sync-entity" value="products"> Products</label>
                        <label><input type="checkbox" class="sync-entity" value="customers"> Customers</label>
                        <label><input type="checkbox" class="sync-entity" value="inventory"> Inventory</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="fieldMappings">Field Mappings (JSON)*</label>
                    <textarea id="fieldMappings" class="form-textarea" rows="6" required placeholder='{"orders": {"d365_field": "local_field"}}'></textarea>
                    <small class="form-text">Map D365 fields to local database fields</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="isActive" checked> Active
                    </label>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('addD365ConfigModal')">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="testD365Connection()">Test Connection</button>
                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewSyncLogModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">Sync Log Details</div>
            <div id="syncLogDetails"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('viewSyncLogModal')">Close</button>
            </div>
        </div>
    </div>
    
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/modules/d365.js"></script>
</body>
</html>
